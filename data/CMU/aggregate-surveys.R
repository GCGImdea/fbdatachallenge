library(dplyr)
library(zoo)
library(readr)
library(stringr)

MIN_SAMPLE_SIZE <- 50

source("utils.R")
data <- get_big_df()

### PREPARE DATA FOR ROLLUP
data$date <- substr(data$StartDatetime, 1, 10)

## ADD FIPS
library(delphiFacebook)

cw_list <- produce_crosswalk_list("../covidcast-indicators/facebook/static")
cc <- group_by(cw_list$county, .data$zip5)
cc <- filter(cc, .data$weight_in_location == max(.data$weight_in_location))
cc <- ungroup(cc)
cc <- select(cc, -.data$weight_in_location)

data <- left_join(data, cc, by = c("A3" = "zip5"))
data <- rename(data, fips = geo_id)

data <- code_df(data)

## Round columns beginning with specified prefix to specified digits after decimal point.
round_df <- function(df, prefix, digits = 4) {
  df %>%
    mutate(across(starts_with(prefix), function(x) round(x, digit = digits)))
}

### CALCULATE AGE BUCKET ROLLUPS (gender is overall)
age_grouped_data = data %>% group_by(date, state_code, fips, gender_overall, age_bucket) %>%
  summarize(
    n = n(),
    weight_sums = sum(weight, na.rm = TRUE),
    pct_cli = mean(cli, na.rm = TRUE)*100,
    pct_ili = mean(ili, na.rm = TRUE)*100,
    pct_cli_anosmia_ageusia = mean(cli_anosmia_ageusia, na.rm = TRUE)*100,
    pct_hh_cli = mean(hh_cli, na.rm = TRUE)*100,
    pct_cmnty_cli = mean(cmnty_cli, na.rm = TRUE)*100,
    pct_A1_1 = mean(A1_1_logic, na.rm = TRUE)*100,
    pct_A1_2 = mean(A1_2_logic, na.rm = TRUE)*100,
    pct_A1_3 = mean(A1_3_logic, na.rm = TRUE)*100,
    pct_A1_4 = mean(A1_4_logic, na.rm = TRUE)*100,
    pct_A1_5 = mean(A1_5_logic, na.rm = TRUE)*100,
    mean_A2 = mean(A2, na.rm = TRUE),
    mean_A4 = mean(A4, na.rm = TRUE),
    pct_B2_1 = mean(B2_1_logic, na.rm = TRUE)*100,
    pct_B2_2 = mean(B2_2_logic, na.rm = TRUE)*100,
    pct_B2_3 = mean(B2_3_logic, na.rm = TRUE)*100,
    pct_B2_4 = mean(B2_4_logic, na.rm = TRUE)*100,
    pct_B2_5 = mean(B2_5_logic, na.rm = TRUE)*100,
    pct_B2_6 = mean(B2_6_logic, na.rm = TRUE)*100,
    pct_B2_7 = mean(B2_7_logic, na.rm = TRUE)*100,
    pct_B2_8 = mean(B2_8_logic, na.rm = TRUE)*100,
    pct_B2_9 = mean(B2_9_logic, na.rm = TRUE)*100,
    pct_B2_10 = mean(B2_10_logic, na.rm = TRUE)*100,
    pct_B2_11 = mean(B2_11_logic, na.rm = TRUE)*100,
    pct_B2_12 = mean(B2_12_logic, na.rm = TRUE)*100,
    pct_B2_13 = mean(B2_13_logic, na.rm = TRUE)*100,
    pct_B2_14 = mean(B2_14_logic, na.rm = TRUE)*100,
    pct_B2_15 = mean(B2_15_logic, na.rm = TRUE)*100,
    pct_B2_multi = mean(B2_multi_logic, na.rm = TRUE)*100,
    pct_B5_1 = mean(B5_1_logic, na.rm = TRUE)*100,
    pct_B5_2 = mean(B5_2_logic, na.rm = TRUE)*100,
    pct_B5_3 = mean(B5_3_logic, na.rm = TRUE)*100,
    pct_B5_4 = mean(B5_4_logic, na.rm = TRUE)*100,
    pct_B5_5 = mean(B5_5_logic, na.rm = TRUE)*100,
    pct_C3 = mean(C3_logic, na.rm = TRUE)*100,
    pct_C7 = mean(C7_logic, na.rm = TRUE)*100,
    mean_C10_1_1 = mean(C10_1_1, na.rm = TRUE),
    mean_C10_2_1 = mean(C10_2_1, na.rm = TRUE),
    mean_C10_3_1 = mean(C10_3_1, na.rm = TRUE),
    pct_C11_1 = mean(C11_logic, na.rm = TRUE)*100,
    pct_C1_1 = mean(C1_1_logic, na.rm = TRUE)*100,
    pct_C1_2 = mean(C1_2_logic, na.rm = TRUE)*100,
    pct_C1_3 = mean(C1_3_logic, na.rm = TRUE)*100,
    pct_C1_4 = mean(C1_4_logic, na.rm = TRUE)*100,
    pct_C1_5 = mean(C1_5_logic, na.rm = TRUE)*100,
    pct_C1_6 = mean(C1_6_logic, na.rm = TRUE)*100,
    pct_C1_7 = mean(C1_7_logic, na.rm = TRUE)*100,
    pct_C1_8 = mean(C1_8_logic, na.rm = TRUE)*100,
    pct_C1_9 = mean(C1_9_logic, na.rm = TRUE)*100,
    pct_C1_multi = mean(C1_multi_logic, na.rm = TRUE)*100.0,
    pct_cli_weighted = sum(cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_ili_weighted = sum(ili*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cli_anosmia_ageusia_weighted = sum(cli_anosmia_ageusia*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_hh_cli_weighted = sum(hh_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cmnty_cli_weighted = sum(cmnty_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_1_weighted = sum(A1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_2_weighted = sum(A1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_3_weighted = sum(A1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_4_weighted = sum(A1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_5_weighted = sum(A1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_A2_weighted = sum(A2*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_A4_weighted = sum(A4*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_B2_1_weighted = sum(B2_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_2_weighted = sum(B2_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_3_weighted = sum(B2_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_4_weighted = sum(B2_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_5_weighted = sum(B2_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_6_weighted = sum(B2_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_7_weighted = sum(B2_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_8_weighted = sum(B2_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_9_weighted = sum(B2_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_10_weighted = sum(B2_10_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_11_weighted = sum(B2_11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_12_weighted = sum(B2_12_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_13_weighted = sum(B2_13_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_14_weighted = sum(B2_14_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_15_weighted = sum(B2_15_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_multi_weighted = sum(B2_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_1_weighted = sum(B5_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_2_weighted = sum(B5_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_3_weighted = sum(B5_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_4_weighted = sum(B5_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_5_weighted = sum(B5_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C3_weighted = sum(C3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C7_weighted = sum(C7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_C10_1_1_weighted = sum(C10_1_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_2_1_weighted = sum(C10_2_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_3_1_weighted = sum(C10_3_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_C11_1_weighted = sum(C11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_1_weighted = sum(C1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_2_weighted = sum(C1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_3_weighted = sum(C1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_4_weighted = sum(C1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_5_weighted = sum(C1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_6_weighted = sum(C1_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_7_weighted = sum(C1_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_8_weighted = sum(C1_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_9_weighted = sum(C1_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_multi_weighted = sum(C1_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE)
  )
names(age_grouped_data)[names(age_grouped_data) == "gender_overall"] <- "gender"
names(age_grouped_data)[names(age_grouped_data) == "age_bucket_overall"] <- "age_bucket"



### CALCULATE GENDER BUCKET ROLLUPS (age is overall)
gender_grouped_data = data %>% group_by(date, state_code, fips, gender, age_bucket_overall) %>%
  summarize(
    n = n(),
    weight_sums = sum(weight, na.rm = TRUE),
    pct_cli = mean(cli, na.rm = TRUE)*100.0,
    pct_ili = mean(ili, na.rm = TRUE)*100.0,
    pct_cli_anosmia_ageusia = mean(cli_anosmia_ageusia, na.rm = TRUE)*100.0,
    pct_hh_cli = mean(hh_cli, na.rm = TRUE)*100,
    pct_cmnty_cli = mean(cmnty_cli, na.rm = TRUE)*100,
    pct_A1_1 = mean(A1_1_logic, na.rm = TRUE)*100.0,
    pct_A1_2 = mean(A1_2_logic, na.rm = TRUE)*100.0,
    pct_A1_3 = mean(A1_3_logic, na.rm = TRUE)*100.0,
    pct_A1_4 = mean(A1_4_logic, na.rm = TRUE)*100.0,
    pct_A1_5 = mean(A1_5_logic, na.rm = TRUE)*100.0,
    mean_A2 = mean(A2, na.rm = TRUE),
    mean_A4 = mean(A4, na.rm = TRUE),
    pct_B2_1 = mean(B2_1_logic, na.rm = TRUE)*100.0,
    pct_B2_2 = mean(B2_2_logic, na.rm = TRUE)*100.0,
    pct_B2_3 = mean(B2_3_logic, na.rm = TRUE)*100.0,
    pct_B2_4 = mean(B2_4_logic, na.rm = TRUE)*100.0,
    pct_B2_5 = mean(B2_5_logic, na.rm = TRUE)*100.0,
    pct_B2_6 = mean(B2_6_logic, na.rm = TRUE)*100.0,
    pct_B2_7 = mean(B2_7_logic, na.rm = TRUE)*100.0,
    pct_B2_8 = mean(B2_8_logic, na.rm = TRUE)*100.0,
    pct_B2_9 = mean(B2_9_logic, na.rm = TRUE)*100.0,
    pct_B2_10 = mean(B2_10_logic, na.rm = TRUE)*100.0,
    pct_B2_11 = mean(B2_11_logic, na.rm = TRUE)*100.0,
    pct_B2_12 = mean(B2_12_logic, na.rm = TRUE)*100.0,
    pct_B2_13 = mean(B2_13_logic, na.rm = TRUE)*100.0,
    pct_B2_14 = mean(B2_14_logic, na.rm = TRUE)*100.0,
    pct_B2_15 = mean(B2_15_logic, na.rm = TRUE)*100.0,
    pct_B2_multi = mean(B2_multi_logic, na.rm = TRUE)*100.0,
    pct_B5_1 = mean(B5_1_logic, na.rm = TRUE)*100.0,
    pct_B5_2 = mean(B5_2_logic, na.rm = TRUE)*100.0,
    pct_B5_3 = mean(B5_3_logic, na.rm = TRUE)*100.0,
    pct_B5_4 = mean(B5_4_logic, na.rm = TRUE)*100.0,
    pct_B5_5 = mean(B5_5_logic, na.rm = TRUE)*100.0,
    pct_C3 = mean(C3_logic, na.rm = TRUE)*100.0,
    pct_C7 = mean(C7_logic, na.rm = TRUE)*100.0,
    mean_C10_1_1 = mean(C10_1_1, na.rm = TRUE),
    mean_C10_2_1 = mean(C10_2_1, na.rm = TRUE),
    mean_C10_3_1 = mean(C10_3_1, na.rm = TRUE),
    pct_C11_1 = mean(C11_logic, na.rm = TRUE)*100.0,
    pct_C1_1 = mean(C1_1_logic, na.rm = TRUE)*100.0,
    pct_C1_2 = mean(C1_2_logic, na.rm = TRUE)*100.0,
    pct_C1_3 = mean(C1_3_logic, na.rm = TRUE)*100.0,
    pct_C1_4 = mean(C1_4_logic, na.rm = TRUE)*100.0,
    pct_C1_5 = mean(C1_5_logic, na.rm = TRUE)*100.0,
    pct_C1_6 = mean(C1_6_logic, na.rm = TRUE)*100.0,
    pct_C1_7 = mean(C1_7_logic, na.rm = TRUE)*100.0,
    pct_C1_8 = mean(C1_8_logic, na.rm = TRUE)*100.0,
    pct_C1_9 = mean(C1_9_logic, na.rm = TRUE)*100.0,
    pct_C1_multi = mean(C1_multi_logic, na.rm = TRUE)*100.0,
    pct_cli_weighted = sum(cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_ili_weighted = sum(ili*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cli_anosmia_ageusia_weighted = sum(cli_anosmia_ageusia*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_hh_cli_weighted = sum(hh_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cmnty_cli_weighted = sum(cmnty_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_1_weighted = sum(A1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_2_weighted = sum(A1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_3_weighted = sum(A1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_4_weighted = sum(A1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_5_weighted = sum(A1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_A2_weighted = sum(A2*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_A4_weighted = sum(A4*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_B2_1_weighted = sum(B2_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_2_weighted = sum(B2_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_3_weighted = sum(B2_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_4_weighted = sum(B2_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_5_weighted = sum(B2_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_6_weighted = sum(B2_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_7_weighted = sum(B2_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_8_weighted = sum(B2_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_9_weighted = sum(B2_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_10_weighted = sum(B2_10_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_11_weighted = sum(B2_11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_12_weighted = sum(B2_12_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_13_weighted = sum(B2_13_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_14_weighted = sum(B2_14_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_15_weighted = sum(B2_15_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_multi_weighted = sum(B2_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_1_weighted = sum(B5_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_2_weighted = sum(B5_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_3_weighted = sum(B5_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_4_weighted = sum(B5_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_5_weighted = sum(B5_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C3_weighted = sum(C3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C7_weighted = sum(C7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_C10_1_1_weighted = sum(C10_1_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_2_1_weighted = sum(C10_2_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_3_1_weighted = sum(C10_3_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_C11_1_weighted = sum(C11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_1_weighted = sum(C1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_2_weighted = sum(C1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_3_weighted = sum(C1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_4_weighted = sum(C1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_5_weighted = sum(C1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_6_weighted = sum(C1_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_7_weighted = sum(C1_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_8_weighted = sum(C1_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_9_weighted = sum(C1_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_multi_weighted = sum(C1_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE)
  )
names(gender_grouped_data)[names(gender_grouped_data) == "gender_overall"] <- "gender"
names(gender_grouped_data)[names(gender_grouped_data) == "age_bucket_overall"] <- "age_bucket"



### CALCULATE OVERALL BUCKET ROLLUPS (gender is overall, age is overall)
overall_grouped_data = data %>% group_by(date, state_code, fips, gender_overall, age_bucket_overall) %>%
  summarize(
    n = n(),
    weight_sums = sum(weight, na.rm = TRUE),
    pct_cli = mean(cli, na.rm = TRUE)*100.0,
    pct_ili = mean(ili, na.rm = TRUE)*100.0,
    pct_cli_anosmia_ageusia = mean(cli_anosmia_ageusia, na.rm = TRUE)*100.0,
    pct_hh_cli = mean(hh_cli, na.rm = TRUE)*100.0,
    pct_cmnty_cli = mean(cmnty_cli, na.rm = TRUE)*100.0,
    pct_A1_1 = mean(A1_1_logic, na.rm = TRUE)*100.0,
    pct_A1_2 = mean(A1_2_logic, na.rm = TRUE)*100.0,
    pct_A1_3 = mean(A1_3_logic, na.rm = TRUE)*100.0,
    pct_A1_4 = mean(A1_4_logic, na.rm = TRUE)*100.0,
    pct_A1_5 = mean(A1_5_logic, na.rm = TRUE)*100.0,
    mean_A2 = mean(A2, na.rm = TRUE),
    mean_A4 = mean(A4, na.rm = TRUE),
    pct_B2_1 = mean(B2_1_logic, na.rm = TRUE)*100.0,
    pct_B2_2 = mean(B2_2_logic, na.rm = TRUE)*100.0,
    pct_B2_3 = mean(B2_3_logic, na.rm = TRUE)*100.0,
    pct_B2_4 = mean(B2_4_logic, na.rm = TRUE)*100.0,
    pct_B2_5 = mean(B2_5_logic, na.rm = TRUE)*100.0,
    pct_B2_6 = mean(B2_6_logic, na.rm = TRUE)*100.0,
    pct_B2_7 = mean(B2_7_logic, na.rm = TRUE)*100.0,
    pct_B2_8 = mean(B2_8_logic, na.rm = TRUE)*100.0,
    pct_B2_9 = mean(B2_9_logic, na.rm = TRUE)*100.0,
    pct_B2_10 = mean(B2_10_logic, na.rm = TRUE)*100.0,
    pct_B2_11 = mean(B2_11_logic, na.rm = TRUE)*100.0,
    pct_B2_12 = mean(B2_12_logic, na.rm = TRUE)*100.0,
    pct_B2_13 = mean(B2_13_logic, na.rm = TRUE)*100.0,
    pct_B2_14 = mean(B2_14_logic, na.rm = TRUE)*100.0,
    pct_B2_15 = mean(B2_15_logic, na.rm = TRUE)*100.0,
    pct_B2_multi = mean(B2_multi_logic, na.rm = TRUE)*100.0,
    pct_B5_1 = mean(B5_1_logic, na.rm = TRUE)*100.0,
    pct_B5_2 = mean(B5_2_logic, na.rm = TRUE)*100.0,
    pct_B5_3 = mean(B5_3_logic, na.rm = TRUE)*100.0,
    pct_B5_4 = mean(B5_4_logic, na.rm = TRUE)*100.0,
    pct_B5_5 = mean(B5_5_logic, na.rm = TRUE)*100.0,
    pct_C3 = mean(C3_logic, na.rm = TRUE)*100.0,
    pct_C7 = mean(C7_logic, na.rm = TRUE)*100.0,
    mean_C10_1_1 = mean(C10_1_1, na.rm = TRUE),
    mean_C10_2_1 = mean(C10_2_1, na.rm = TRUE),
    mean_C10_3_1 = mean(C10_3_1, na.rm = TRUE),
    pct_C11_1 = mean(C11_logic, na.rm = TRUE)*100.0,
    pct_C1_1 = mean(C1_1_logic, na.rm = TRUE)*100.0,
    pct_C1_2 = mean(C1_2_logic, na.rm = TRUE)*100.0,
    pct_C1_3 = mean(C1_3_logic, na.rm = TRUE)*100.0,
    pct_C1_4 = mean(C1_4_logic, na.rm = TRUE)*100.0,
    pct_C1_5 = mean(C1_5_logic, na.rm = TRUE)*100.0,
    pct_C1_6 = mean(C1_6_logic, na.rm = TRUE)*100.0,
    pct_C1_7 = mean(C1_7_logic, na.rm = TRUE)*100.0,
    pct_C1_8 = mean(C1_8_logic, na.rm = TRUE)*100.0,
    pct_C1_9 = mean(C1_9_logic, na.rm = TRUE)*100.0,
    pct_C1_multi = mean(C1_multi_logic, na.rm = TRUE)*100.0,
    pct_cli_weighted = sum(cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_ili_weighted = sum(ili*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cli_anosmia_ageusia_weighted = sum(cli_anosmia_ageusia*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_hh_cli_weighted = sum(hh_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cmnty_cli_weighted = sum(cmnty_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_1_weighted = sum(A1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_2_weighted = sum(A1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_3_weighted = sum(A1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_4_weighted = sum(A1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_5_weighted = sum(A1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_A2_weighted = sum(A2*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_A4_weighted = sum(A4*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_B2_1_weighted = sum(B2_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_2_weighted = sum(B2_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_3_weighted = sum(B2_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_4_weighted = sum(B2_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_5_weighted = sum(B2_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_6_weighted = sum(B2_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_7_weighted = sum(B2_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_8_weighted = sum(B2_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_9_weighted = sum(B2_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_10_weighted = sum(B2_10_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_11_weighted = sum(B2_11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_12_weighted = sum(B2_12_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_13_weighted = sum(B2_13_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_14_weighted = sum(B2_14_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_15_weighted = sum(B2_15_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_multi_weighted = sum(B2_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_1_weighted = sum(B5_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_2_weighted = sum(B5_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_3_weighted = sum(B5_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_4_weighted = sum(B5_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_5_weighted = sum(B5_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C3_weighted = sum(C3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C7_weighted = sum(C7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_C10_1_1_weighted = sum(C10_1_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_2_1_weighted = sum(C10_2_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_3_1_weighted = sum(C10_3_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_C11_1_weighted = sum(C11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_1_weighted = sum(C1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_2_weighted = sum(C1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_3_weighted = sum(C1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_4_weighted = sum(C1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_5_weighted = sum(C1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_6_weighted = sum(C1_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_7_weighted = sum(C1_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_8_weighted = sum(C1_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_9_weighted = sum(C1_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_multi_weighted = sum(C1_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE)
  )
names(overall_grouped_data)[names(overall_grouped_data) == "gender_overall"] <- "gender"
names(overall_grouped_data)[names(overall_grouped_data) == "age_bucket_overall"] <- "age_bucket"

### UNION ALL THE DATA TOGETHER
nrow(gender_grouped_data) +
nrow(age_grouped_data) +
nrow(overall_grouped_data)

overall = rbind(gender_grouped_data, age_grouped_data, overall_grouped_data)

### FILTER ONLY ONLY ROWS THAT HAVE GREATER THAN MINIMUM RESPONSES
overall_filt = overall[which(overall$n >= MIN_SAMPLE_SIZE), ]

overall_filt <- round_df(overall_filt, "pct_")
overall_filt <- round_df(overall_filt, "mean_")

overall_filt_fixed_names <- overall_filt

for (col in names(overall_filt)) {
  core <- str_remove(str_remove(str_remove(str_remove(col, 'pct_'), '_weighted'), 'smoothed_'), 'mean_')
  variable <- col_dict$get(core)
  fixed <- gsub(core, variable, col)
  names(overall_filt_fixed_names)[names(overall_filt_fixed_names) == col] <- fixed
}

write_csv(overall_filt_fixed_names, "overall-county.csv")


### SMOOTH ALL THE DATA (LAST 7 DAYS), USING THE AGGREGATED DATA ABOVE.
# All smoothing done by multiplying any day's results by the sample size of the day, and then dividing by the sum of sample across all the days
smoothed_overall = overall %>%
    arrange(state_code, fips, gender, age_bucket, desc(date)) %>%
    group_by(state_code, fips, gender, age_bucket) %>%
    mutate(summed_n = rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_cli = rollsum(pct_cli*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_ili = rollsum(pct_ili*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_cli_anosmia_ageusia = rollsum(pct_cli_anosmia_ageusia*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_hh_cli = rollsum(pct_hh_cli*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_cmnty_cli = rollsum(pct_cmnty_cli*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_1 = rollsum(pct_A1_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_2 = rollsum(pct_A1_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_3 = rollsum(pct_A1_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_4 = rollsum(pct_A1_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_5 = rollsum(pct_A1_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_A2 = rollsum(mean_A2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_A4 = rollsum(mean_A4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_1 = rollsum(pct_B2_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_2 = rollsum(pct_B2_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_3 = rollsum(pct_B2_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_4 = rollsum(pct_B2_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_5 = rollsum(pct_B2_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_6 = rollsum(pct_B2_6*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_7 = rollsum(pct_B2_7*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_8 = rollsum(pct_B2_8*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_9 = rollsum(pct_B2_9*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_10 = rollsum(pct_B2_10*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_11 = rollsum(pct_B2_11*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_12 = rollsum(pct_B2_12*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_13 = rollsum(pct_B2_13*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_14 = rollsum(pct_B2_14*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_15 = rollsum(pct_B2_15*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_multi = rollsum(pct_B2_multi*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_1 = rollsum(pct_B5_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_2 = rollsum(pct_B5_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_3 = rollsum(pct_B5_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_4 = rollsum(pct_B5_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_5 = rollsum(pct_B5_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C3 = rollsum(pct_C3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C7 = rollsum(pct_C7*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_C10_1_1 = rollsum(mean_C10_1_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_C10_2_1 = rollsum(mean_C10_2_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_C10_3_1 = rollsum(mean_C10_3_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C11_1 = rollsum(pct_C11_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_1 = rollsum(pct_C1_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_2 = rollsum(pct_C1_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_3 = rollsum(pct_C1_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_4 = rollsum(pct_C1_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_5 = rollsum(pct_C1_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_6 = rollsum(pct_C1_6*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_7 = rollsum(pct_C1_7*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_8 = rollsum(pct_C1_8*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_9 = rollsum(pct_C1_9*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_multi = rollsum(pct_C1_multi*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_cli_weighted = rollsum(pct_cli_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_ili_weighted = rollsum(pct_ili_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_cli_anosmia_ageusia_weighted = rollsum(pct_cli_anosmia_ageusia_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_hh_cli_weighted = rollsum(pct_hh_cli_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_cmnty_cli_weighted = rollsum(pct_cmnty_cli_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_1_weighted = rollsum(pct_A1_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_2_weighted = rollsum(pct_A1_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_3_weighted = rollsum(pct_A1_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_4_weighted = rollsum(pct_A1_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_A1_5_weighted = rollsum(pct_A1_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_A2_weighted = rollsum(mean_A2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_A4_weighted = rollsum(mean_A4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_1_weighted = rollsum(pct_B2_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_2_weighted = rollsum(pct_B2_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_3_weighted = rollsum(pct_B2_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_4_weighted = rollsum(pct_B2_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_5_weighted = rollsum(pct_B2_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_6_weighted = rollsum(pct_B2_6_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_7_weighted = rollsum(pct_B2_7_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_8_weighted = rollsum(pct_B2_8_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_9_weighted = rollsum(pct_B2_9_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_10_weighted = rollsum(pct_B2_10_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_11_weighted = rollsum(pct_B2_11_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_12_weighted = rollsum(pct_B2_12_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_13_weighted = rollsum(pct_B2_13_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_14_weighted = rollsum(pct_B2_14_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_15_weighted = rollsum(pct_B2_15_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B2_multi_weighted = rollsum(pct_B2_multi_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_1_weighted = rollsum(pct_B5_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_2_weighted = rollsum(pct_B5_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_3_weighted = rollsum(pct_B5_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_4_weighted = rollsum(pct_B5_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_B5_5_weighted = rollsum(pct_B5_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C3_weighted = rollsum(pct_C3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C7_weighted = rollsum(pct_C7_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_C10_1_1_weighted = rollsum(mean_C10_1_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_C10_2_1_weighted = rollsum(mean_C10_2_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_mean_C10_3_1_weighted = rollsum(mean_C10_3_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C11_1_weighted = rollsum(pct_C11_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_1_weighted = rollsum(pct_C1_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_2_weighted = rollsum(pct_C1_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_3_weighted = rollsum(pct_C1_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_4_weighted = rollsum(pct_C1_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_5_weighted = rollsum(pct_C1_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_6_weighted = rollsum(pct_C1_6_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_7_weighted = rollsum(pct_C1_7_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_8_weighted = rollsum(pct_C1_8_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_9_weighted = rollsum(pct_C1_9_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           smoothed_pct_C1_multi_weighted = rollsum(pct_C1_multi_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
           )

key_smoothed_variables <- c('date', 'state_code', 'fips', 'gender', 'age_bucket', 'summed_n','smoothed_pct_cli','smoothed_pct_ili', 'smoothed_pct_cli_anosmia_ageusia', 'smoothed_pct_hh_cli','smoothed_pct_cmnty_cli', 'smoothed_pct_A1_1','smoothed_pct_A1_2','smoothed_pct_A1_3',
                            'smoothed_pct_A1_4','smoothed_pct_A1_5','smoothed_mean_A2','smoothed_mean_A4','smoothed_pct_B2_1', 'smoothed_pct_B2_2', 'smoothed_pct_B2_3', 'smoothed_pct_B2_4',
                            'smoothed_pct_B2_5', 'smoothed_pct_B2_6', 'smoothed_pct_B2_7', 'smoothed_pct_B2_8', 'smoothed_pct_B2_9', 'smoothed_pct_B2_10',
                            'smoothed_pct_B2_11', 'smoothed_pct_B2_12', 'smoothed_pct_B2_13', 'smoothed_pct_B2_14', 'smoothed_pct_B2_15', 'smoothed_pct_B2_multi',
                            'smoothed_pct_B5_1', 'smoothed_pct_B5_2', 'smoothed_pct_B5_3', 'smoothed_pct_B5_4', 'smoothed_pct_B5_5', 'smoothed_pct_C3','smoothed_pct_C7',
                            'smoothed_mean_C10_1_1','smoothed_mean_C10_2_1','smoothed_mean_C10_3_1','smoothed_pct_C11_1','smoothed_pct_C1_1','smoothed_pct_C1_2','smoothed_pct_C1_3',
                            'smoothed_pct_C1_4','smoothed_pct_C1_5','smoothed_pct_C1_6','smoothed_pct_C1_7','smoothed_pct_C1_8','smoothed_pct_C1_9','smoothed_pct_C1_multi','smoothed_pct_cli_weighted',
                            'smoothed_pct_ili_weighted', 'smoothed_pct_cli_anosmia_ageusia_weighted', 'smoothed_pct_hh_cli_weighted','smoothed_pct_cmnty_cli_weighted', 'smoothed_pct_A1_1_weighted','smoothed_pct_A1_2_weighted','smoothed_pct_A1_3_weighted','smoothed_pct_A1_4_weighted',
                            'smoothed_pct_A1_5_weighted','smoothed_mean_A2_weighted','smoothed_mean_A4_weighted','smoothed_pct_B2_1_weighted', 'smoothed_pct_B2_2_weighted', 'smoothed_pct_B2_3_weighted',
                            'smoothed_pct_B2_4_weighted', 'smoothed_pct_B2_5_weighted', 'smoothed_pct_B2_6_weighted', 'smoothed_pct_B2_7_weighted', 'smoothed_pct_B2_8_weighted','smoothed_pct_B2_9_weighted',
                            'smoothed_pct_B2_10_weighted','smoothed_pct_B2_11_weighted', 'smoothed_pct_B2_12_weighted', 'smoothed_pct_B2_13_weighted', 'smoothed_pct_B2_14_weighted', 'smoothed_pct_B2_15_weighted',
                             'smoothed_pct_B2_multi_weighted', 'smoothed_pct_B5_1_weighted', 'smoothed_pct_B5_2_weighted', 'smoothed_pct_B5_3_weighted',
                            'smoothed_pct_B5_4_weighted', 'smoothed_pct_B5_5_weighted', 'smoothed_pct_C3_weighted',
                            'smoothed_pct_C7_weighted','smoothed_mean_C10_1_1_weighted', 'smoothed_mean_C10_2_1_weighted','smoothed_mean_C10_3_1_weighted', 'smoothed_pct_C11_1_weighted', 'smoothed_pct_C1_1_weighted','smoothed_pct_C1_2_weighted','smoothed_pct_C1_3_weighted','smoothed_pct_C1_4_weighted','smoothed_pct_C1_5_weighted',
                            'smoothed_pct_C1_6_weighted','smoothed_pct_C1_7_weighted','smoothed_pct_C1_8_weighted','smoothed_pct_C1_9_weighted','smoothed_pct_C1_multi_weighted')

smoothed_overall_rel_columns = smoothed_overall[key_smoothed_variables]
smoothed_overall_filt = smoothed_overall_rel_columns[which(smoothed_overall_rel_columns$summed_n >= MIN_SAMPLE_SIZE),]

smoothed_overall_filt <- round_df(smoothed_overall_filt, "smoothed_")

smoothed_overall_filt_fixed_names <- smoothed_overall_filt

for (col in names(smoothed_overall_filt_fixed_names)) {
  core <- str_remove(str_remove(str_remove(str_remove(col, 'pct_'), '_weighted'), 'smoothed_'), 'mean_')
  variable <- col_dict$get(core)
  fixed <- gsub(core, variable, col)
  names(smoothed_overall_filt_fixed_names)[names(smoothed_overall_filt_fixed_names) == col] <- fixed
}

write_csv(smoothed_overall_filt_fixed_names, "overall-county-smoothed.csv")


################################################################################################################################################################################################
######## STATE
################################################################################################################################################################################################
### CALCULATE GENDER, AGE BUCKET ROLLUPS
state_gender_age_grouped_data = data %>% group_by(date, state_code, gender, age_bucket) %>%
  summarize(
    n = n(),
    weight_sums = sum(weight, na.rm = TRUE),
    pct_cli = mean(cli, na.rm = TRUE)*100.0,
    pct_ili = mean(ili, na.rm = TRUE)*100.0,
    pct_cli_anosmia_ageusia = mean(cli_anosmia_ageusia, na.rm = TRUE)*100.0,
    pct_hh_cli = mean(hh_cli, na.rm = TRUE)*100.0,
    pct_cmnty_cli = mean(cmnty_cli, na.rm = TRUE)*100.0,
    pct_A1_1 = mean(A1_1_logic, na.rm = TRUE)*100.0,
    pct_A1_2 = mean(A1_2_logic, na.rm = TRUE)*100.0,
    pct_A1_3 = mean(A1_3_logic, na.rm = TRUE)*100.0,
    pct_A1_4 = mean(A1_4_logic, na.rm = TRUE)*100.0,
    pct_A1_5 = mean(A1_5_logic, na.rm = TRUE)*100.0,
    mean_A2 = mean(A2, na.rm = TRUE),
    mean_A4 = mean(A4, na.rm = TRUE),
    pct_B2_1 = mean(B2_1_logic, na.rm = TRUE)*100.0,
    pct_B2_2 = mean(B2_2_logic, na.rm = TRUE)*100.0,
    pct_B2_3 = mean(B2_3_logic, na.rm = TRUE)*100.0,
    pct_B2_4 = mean(B2_4_logic, na.rm = TRUE)*100.0,
    pct_B2_5 = mean(B2_5_logic, na.rm = TRUE)*100.0,
    pct_B2_6 = mean(B2_6_logic, na.rm = TRUE)*100.0,
    pct_B2_7 = mean(B2_7_logic, na.rm = TRUE)*100.0,
    pct_B2_8 = mean(B2_8_logic, na.rm = TRUE)*100.0,
    pct_B2_9 = mean(B2_9_logic, na.rm = TRUE)*100.0,
    pct_B2_10 = mean(B2_10_logic, na.rm = TRUE)*100.0,
    pct_B2_11 = mean(B2_11_logic, na.rm = TRUE)*100.0,
    pct_B2_12 = mean(B2_12_logic, na.rm = TRUE)*100.0,
    pct_B2_13 = mean(B2_13_logic, na.rm = TRUE)*100.0,
    pct_B2_14 = mean(B2_14_logic, na.rm = TRUE)*100.0,
    pct_B2_15 = mean(B2_15_logic, na.rm = TRUE)*100.0,
    pct_B2_multi = mean(B2_multi_logic, na.rm = TRUE)*100.0,
    pct_B5_1 = mean(B5_1_logic, na.rm = TRUE)*100.0,
    pct_B5_2 = mean(B5_2_logic, na.rm = TRUE)*100.0,
    pct_B5_3 = mean(B5_3_logic, na.rm = TRUE)*100.0,
    pct_B5_4 = mean(B5_4_logic, na.rm = TRUE)*100.0,
    pct_B5_5 = mean(B5_5_logic, na.rm = TRUE)*100.0,
    pct_C3 = mean(C3_logic, na.rm = TRUE)*100.0,
    pct_C7 = mean(C7_logic, na.rm = TRUE)*100.0,
    mean_C10_1_1 = mean(C10_1_1, na.rm = TRUE),
    mean_C10_2_1 = mean(C10_2_1, na.rm = TRUE),
    mean_C10_3_1 = mean(C10_3_1, na.rm = TRUE),
    pct_C11_1 = mean(C11_logic, na.rm = TRUE)*100.0,
    pct_C1_1 = mean(C1_1_logic, na.rm = TRUE)*100.0,
    pct_C1_2 = mean(C1_2_logic, na.rm = TRUE)*100.0,
    pct_C1_3 = mean(C1_3_logic, na.rm = TRUE)*100.0,
    pct_C1_4 = mean(C1_4_logic, na.rm = TRUE)*100.0,
    pct_C1_5 = mean(C1_5_logic, na.rm = TRUE)*100.0,
    pct_C1_6 = mean(C1_6_logic, na.rm = TRUE)*100.0,
    pct_C1_7 = mean(C1_7_logic, na.rm = TRUE)*100.0,
    pct_C1_8 = mean(C1_8_logic, na.rm = TRUE)*100.0,
    pct_C1_9 = mean(C1_9_logic, na.rm = TRUE)*100.0,
    pct_C1_multi = mean(C1_multi_logic, na.rm = TRUE)*100.0,
    pct_cli_weighted = sum(cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_ili_weighted = sum(ili*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cli_anosmia_ageusia_weighted = sum(cli_anosmia_ageusia*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_hh_cli_weighted = sum(hh_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cmnty_cli_weighted = sum(cmnty_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_1_weighted = sum(A1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_2_weighted = sum(A1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_3_weighted = sum(A1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_4_weighted = sum(A1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_5_weighted = sum(A1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_A2_weighted = sum(A2*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_A4_weighted = sum(A4*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_B2_1_weighted = sum(B2_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_2_weighted = sum(B2_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_3_weighted = sum(B2_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_4_weighted = sum(B2_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_5_weighted = sum(B2_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_6_weighted = sum(B2_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_7_weighted = sum(B2_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_8_weighted = sum(B2_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_9_weighted = sum(B2_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_10_weighted = sum(B2_10_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_11_weighted = sum(B2_11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_12_weighted = sum(B2_12_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_13_weighted = sum(B2_13_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_14_weighted = sum(B2_14_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_15_weighted = sum(B2_15_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_multi_weighted = sum(B2_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_1_weighted = sum(B5_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_2_weighted = sum(B5_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_3_weighted = sum(B5_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_4_weighted = sum(B5_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_5_weighted = sum(B5_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C3_weighted = sum(C3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C7_weighted = sum(C7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_C10_1_1_weighted = sum(C10_1_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_2_1_weighted = sum(C10_2_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_3_1_weighted = sum(C10_3_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_C11_1_weighted = sum(C11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_1_weighted = sum(C1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_2_weighted = sum(C1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_3_weighted = sum(C1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_4_weighted = sum(C1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_5_weighted = sum(C1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_6_weighted = sum(C1_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_7_weighted = sum(C1_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_8_weighted = sum(C1_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_9_weighted = sum(C1_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_multi_weighted = sum(C1_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE)
  )

### CALCULATE AGE BUCKET ROLLUPS (gender is overall)
state_age_grouped_data = data %>% group_by(date, state_code, gender_overall, age_bucket) %>%
  summarize(
    n = n(),
    weight_sums = sum(weight, na.rm = TRUE),
    pct_cli = mean(cli, na.rm = TRUE)*100.0,
    pct_ili = mean(ili, na.rm = TRUE)*100.0,
    pct_cli_anosmia_ageusia = mean(cli_anosmia_ageusia, na.rm = TRUE)*100.0,
    pct_hh_cli = mean(hh_cli, na.rm = TRUE)*100.0,
    pct_cmnty_cli = mean(cmnty_cli, na.rm = TRUE)*100.0,
    pct_A1_1 = mean(A1_1_logic, na.rm = TRUE)*100.0,
    pct_A1_2 = mean(A1_2_logic, na.rm = TRUE)*100.0,
    pct_A1_3 = mean(A1_3_logic, na.rm = TRUE)*100.0,
    pct_A1_4 = mean(A1_4_logic, na.rm = TRUE)*100.0,
    pct_A1_5 = mean(A1_5_logic, na.rm = TRUE)*100.0,
    mean_A2 = mean(A2, na.rm = TRUE),
    mean_A4 = mean(A4, na.rm = TRUE),
    pct_B2_1 = mean(B2_1_logic, na.rm = TRUE)*100.0,
    pct_B2_2 = mean(B2_2_logic, na.rm = TRUE)*100.0,
    pct_B2_3 = mean(B2_3_logic, na.rm = TRUE)*100.0,
    pct_B2_4 = mean(B2_4_logic, na.rm = TRUE)*100.0,
    pct_B2_5 = mean(B2_5_logic, na.rm = TRUE)*100.0,
    pct_B2_6 = mean(B2_6_logic, na.rm = TRUE)*100.0,
    pct_B2_7 = mean(B2_7_logic, na.rm = TRUE)*100.0,
    pct_B2_8 = mean(B2_8_logic, na.rm = TRUE)*100.0,
    pct_B2_9 = mean(B2_9_logic, na.rm = TRUE)*100.0,
    pct_B2_10 = mean(B2_10_logic, na.rm = TRUE)*100.0,
    pct_B2_11 = mean(B2_11_logic, na.rm = TRUE)*100.0,
    pct_B2_12 = mean(B2_12_logic, na.rm = TRUE)*100.0,
    pct_B2_13 = mean(B2_13_logic, na.rm = TRUE)*100.0,
    pct_B2_14 = mean(B2_14_logic, na.rm = TRUE)*100.0,
    pct_B2_15 = mean(B2_15_logic, na.rm = TRUE)*100.0,
    pct_B2_multi = mean(B2_multi_logic, na.rm = TRUE)*100.0,
    pct_B5_1 = mean(B5_1_logic, na.rm = TRUE)*100.0,
    pct_B5_2 = mean(B5_2_logic, na.rm = TRUE)*100.0,
    pct_B5_3 = mean(B5_3_logic, na.rm = TRUE)*100.0,
    pct_B5_4 = mean(B5_4_logic, na.rm = TRUE)*100.0,
    pct_B5_5 = mean(B5_5_logic, na.rm = TRUE)*100.0,
    pct_C3 = mean(C3_logic, na.rm = TRUE)*100.0,
    pct_C7 = mean(C7_logic, na.rm = TRUE)*100.0,
    mean_C10_1_1 = mean(C10_1_1, na.rm = TRUE),
    mean_C10_2_1 = mean(C10_2_1, na.rm = TRUE),
    mean_C10_3_1 = mean(C10_3_1, na.rm = TRUE),
    pct_C11_1 = mean(C11_logic, na.rm = TRUE)*100.0,
    pct_C1_1 = mean(C1_1_logic, na.rm = TRUE)*100.0,
    pct_C1_2 = mean(C1_2_logic, na.rm = TRUE)*100.0,
    pct_C1_3 = mean(C1_3_logic, na.rm = TRUE)*100.0,
    pct_C1_4 = mean(C1_4_logic, na.rm = TRUE)*100.0,
    pct_C1_5 = mean(C1_5_logic, na.rm = TRUE)*100.0,
    pct_C1_6 = mean(C1_6_logic, na.rm = TRUE)*100.0,
    pct_C1_7 = mean(C1_7_logic, na.rm = TRUE)*100.0,
    pct_C1_8 = mean(C1_8_logic, na.rm = TRUE)*100.0,
    pct_C1_9 = mean(C1_9_logic, na.rm = TRUE)*100.0,
    pct_C1_multi = mean(C1_multi_logic, na.rm = TRUE)*100.0,
    pct_cli_weighted = sum(cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_ili_weighted = sum(ili*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cli_anosmia_ageusia_weighted = sum(cli_anosmia_ageusia*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_hh_cli_weighted = sum(hh_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cmnty_cli_weighted = sum(cmnty_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_1_weighted = sum(A1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_2_weighted = sum(A1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_3_weighted = sum(A1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_4_weighted = sum(A1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_5_weighted = sum(A1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_A2_weighted = sum(A2*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_A4_weighted = sum(A4*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_B2_1_weighted = sum(B2_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_2_weighted = sum(B2_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_3_weighted = sum(B2_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_4_weighted = sum(B2_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_5_weighted = sum(B2_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_6_weighted = sum(B2_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_7_weighted = sum(B2_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_8_weighted = sum(B2_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_9_weighted = sum(B2_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_10_weighted = sum(B2_10_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_11_weighted = sum(B2_11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_12_weighted = sum(B2_12_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_13_weighted = sum(B2_13_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_14_weighted = sum(B2_14_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_15_weighted = sum(B2_15_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_multi_weighted = sum(B2_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_1_weighted = sum(B5_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_2_weighted = sum(B5_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_3_weighted = sum(B5_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_4_weighted = sum(B5_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_5_weighted = sum(B5_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C3_weighted = sum(C3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C7_weighted = sum(C7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_C10_1_1_weighted = sum(C10_1_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_2_1_weighted = sum(C10_2_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_3_1_weighted = sum(C10_3_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_C11_1_weighted = sum(C11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_1_weighted = sum(C1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_2_weighted = sum(C1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_3_weighted = sum(C1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_4_weighted = sum(C1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_5_weighted = sum(C1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_6_weighted = sum(C1_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_7_weighted = sum(C1_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_8_weighted = sum(C1_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_9_weighted = sum(C1_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_multi_weighted = sum(C1_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE)
  )
names(state_age_grouped_data)[names(state_age_grouped_data) == "gender_overall"] <- "gender"
names(state_age_grouped_data)[names(state_age_grouped_data) == "age_bucket_overall"] <- "age_bucket"



### CALCULATE GENDER BUCKET ROLLUPS (age is overall)
state_gender_grouped_data = data %>% group_by(date, state_code, gender, age_bucket_overall) %>%
  summarize(
    n = n(),
    weight_sums = sum(weight, na.rm = TRUE),
    pct_cli = mean(cli, na.rm = TRUE)*100.0,
    pct_ili = mean(ili, na.rm = TRUE)*100.0,
    pct_cli_anosmia_ageusia = mean(cli_anosmia_ageusia, na.rm = TRUE)*100.0,
    pct_hh_cli = mean(hh_cli, na.rm = TRUE)*100.0,
    pct_cmnty_cli = mean(cmnty_cli, na.rm = TRUE)*100.0,
    pct_A1_1 = mean(A1_1_logic, na.rm = TRUE)*100.0,
    pct_A1_2 = mean(A1_2_logic, na.rm = TRUE)*100.0,
    pct_A1_3 = mean(A1_3_logic, na.rm = TRUE)*100.0,
    pct_A1_4 = mean(A1_4_logic, na.rm = TRUE)*100.0,
    pct_A1_5 = mean(A1_5_logic, na.rm = TRUE)*100.0,
    mean_A2 = mean(A2, na.rm = TRUE),
    mean_A4 = mean(A4, na.rm = TRUE),
    pct_B2_1 = mean(B2_1_logic, na.rm = TRUE)*100.0,
    pct_B2_2 = mean(B2_2_logic, na.rm = TRUE)*100.0,
    pct_B2_3 = mean(B2_3_logic, na.rm = TRUE)*100.0,
    pct_B2_4 = mean(B2_4_logic, na.rm = TRUE)*100.0,
    pct_B2_5 = mean(B2_5_logic, na.rm = TRUE)*100.0,
    pct_B2_6 = mean(B2_6_logic, na.rm = TRUE)*100.0,
    pct_B2_7 = mean(B2_7_logic, na.rm = TRUE)*100.0,
    pct_B2_8 = mean(B2_8_logic, na.rm = TRUE)*100.0,
    pct_B2_9 = mean(B2_9_logic, na.rm = TRUE)*100.0,
    pct_B2_10 = mean(B2_10_logic, na.rm = TRUE)*100.0,
    pct_B2_11 = mean(B2_11_logic, na.rm = TRUE)*100.0,
    pct_B2_12 = mean(B2_12_logic, na.rm = TRUE)*100.0,
    pct_B2_13 = mean(B2_13_logic, na.rm = TRUE)*100.0,
    pct_B2_14 = mean(B2_14_logic, na.rm = TRUE)*100.0,
    pct_B2_15 = mean(B2_15_logic, na.rm = TRUE)*100.0,
    pct_B2_multi = mean(B2_multi_logic, na.rm = TRUE)*100.0,
    pct_B5_1 = mean(B5_1_logic, na.rm = TRUE)*100.0,
    pct_B5_2 = mean(B5_2_logic, na.rm = TRUE)*100.0,
    pct_B5_3 = mean(B5_3_logic, na.rm = TRUE)*100.0,
    pct_B5_4 = mean(B5_4_logic, na.rm = TRUE)*100.0,
    pct_B5_5 = mean(B5_5_logic, na.rm = TRUE)*100.0,
    pct_C3 = mean(C3_logic, na.rm = TRUE)*100.0,
    pct_C7 = mean(C7_logic, na.rm = TRUE)*100.0,
    mean_C10_1_1 = mean(C10_1_1, na.rm = TRUE),
    mean_C10_2_1 = mean(C10_2_1, na.rm = TRUE),
    mean_C10_3_1 = mean(C10_3_1, na.rm = TRUE),
    pct_C11_1 = mean(C11_logic, na.rm = TRUE)*100.0,
    pct_C1_1 = mean(C1_1_logic, na.rm = TRUE)*100.0,
    pct_C1_2 = mean(C1_2_logic, na.rm = TRUE)*100.0,
    pct_C1_3 = mean(C1_3_logic, na.rm = TRUE)*100.0,
    pct_C1_4 = mean(C1_4_logic, na.rm = TRUE)*100.0,
    pct_C1_5 = mean(C1_5_logic, na.rm = TRUE)*100.0,
    pct_C1_6 = mean(C1_6_logic, na.rm = TRUE)*100.0,
    pct_C1_7 = mean(C1_7_logic, na.rm = TRUE)*100.0,
    pct_C1_8 = mean(C1_8_logic, na.rm = TRUE)*100.0,
    pct_C1_9 = mean(C1_9_logic, na.rm = TRUE)*100.0,
    pct_C1_multi = mean(C1_multi_logic, na.rm = TRUE)*100.0,
    pct_cli_weighted = sum(cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_ili_weighted = sum(ili*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cli_anosmia_ageusia_weighted = sum(cli_anosmia_ageusia*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_hh_cli_weighted = sum(hh_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cmnty_cli_weighted = sum(cmnty_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_1_weighted = sum(A1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_2_weighted = sum(A1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_3_weighted = sum(A1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_4_weighted = sum(A1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_5_weighted = sum(A1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_A2_weighted = sum(A2*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_A4_weighted = sum(A4*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_B2_1_weighted = sum(B2_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_2_weighted = sum(B2_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_3_weighted = sum(B2_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_4_weighted = sum(B2_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_5_weighted = sum(B2_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_6_weighted = sum(B2_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_7_weighted = sum(B2_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_8_weighted = sum(B2_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_9_weighted = sum(B2_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_10_weighted = sum(B2_10_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_11_weighted = sum(B2_11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_12_weighted = sum(B2_12_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_13_weighted = sum(B2_13_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_14_weighted = sum(B2_14_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_15_weighted = sum(B2_15_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_multi_weighted = sum(B2_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_1_weighted = sum(B5_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_2_weighted = sum(B5_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_3_weighted = sum(B5_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_4_weighted = sum(B5_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_5_weighted = sum(B5_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C3_weighted = sum(C3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C7_weighted = sum(C7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_C10_1_1_weighted = sum(C10_1_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_2_1_weighted = sum(C10_2_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_3_1_weighted = sum(C10_3_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_C11_1_weighted = sum(C11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_1_weighted = sum(C1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_2_weighted = sum(C1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_3_weighted = sum(C1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_4_weighted = sum(C1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_5_weighted = sum(C1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_6_weighted = sum(C1_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_7_weighted = sum(C1_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_8_weighted = sum(C1_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_9_weighted = sum(C1_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_multi_weighted = sum(C1_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE)
  )
names(state_gender_grouped_data)[names(state_gender_grouped_data) == "gender_overall"] <- "gender"
names(state_gender_grouped_data)[names(state_gender_grouped_data) == "age_bucket_overall"] <- "age_bucket"



### CALCULATE OVERALL BUCKET ROLLUPS (gender is overall, age is overall)
state_overall_grouped_data = data %>% group_by(date, state_code, gender_overall, age_bucket_overall) %>%
  summarize(
    n = n(),
    weight_sums = sum(weight, na.rm = TRUE),
    pct_cli = mean(cli, na.rm = TRUE)*100.0,
    pct_ili = mean(ili, na.rm = TRUE)*100.0,
    pct_cli_anosmia_ageusia = mean(cli_anosmia_ageusia, na.rm = TRUE)*100.0,
    pct_hh_cli = mean(hh_cli, na.rm = TRUE)*100.0,
    pct_cmnty_cli = mean(cmnty_cli, na.rm = TRUE)*100.0,
    pct_A1_1 = mean(A1_1_logic, na.rm = TRUE)*100.0,
    pct_A1_2 = mean(A1_2_logic, na.rm = TRUE)*100.0,
    pct_A1_3 = mean(A1_3_logic, na.rm = TRUE)*100.0,
    pct_A1_4 = mean(A1_4_logic, na.rm = TRUE)*100.0,
    pct_A1_5 = mean(A1_5_logic, na.rm = TRUE)*100.0,
    mean_A2 = mean(A2, na.rm = TRUE),
    mean_A4 = mean(A4, na.rm = TRUE),
    pct_B2_1 = mean(B2_1_logic, na.rm = TRUE)*100.0,
    pct_B2_2 = mean(B2_2_logic, na.rm = TRUE)*100.0,
    pct_B2_3 = mean(B2_3_logic, na.rm = TRUE)*100.0,
    pct_B2_4 = mean(B2_4_logic, na.rm = TRUE)*100.0,
    pct_B2_5 = mean(B2_5_logic, na.rm = TRUE)*100.0,
    pct_B2_6 = mean(B2_6_logic, na.rm = TRUE)*100.0,
    pct_B2_7 = mean(B2_7_logic, na.rm = TRUE)*100.0,
    pct_B2_8 = mean(B2_8_logic, na.rm = TRUE)*100.0,
    pct_B2_9 = mean(B2_9_logic, na.rm = TRUE)*100.0,
    pct_B2_10 = mean(B2_10_logic, na.rm = TRUE)*100.0,
    pct_B2_11 = mean(B2_11_logic, na.rm = TRUE)*100.0,
    pct_B2_12 = mean(B2_12_logic, na.rm = TRUE)*100.0,
    pct_B2_13 = mean(B2_13_logic, na.rm = TRUE)*100.0,
    pct_B2_14 = mean(B2_14_logic, na.rm = TRUE)*100.0,
    pct_B2_15 = mean(B2_15_logic, na.rm = TRUE)*100.0,
    pct_B2_multi = mean(B2_multi_logic, na.rm = TRUE)*100.0,
    pct_B5_1 = mean(B5_1_logic, na.rm = TRUE)*100.0,
    pct_B5_2 = mean(B5_2_logic, na.rm = TRUE)*100.0,
    pct_B5_3 = mean(B5_3_logic, na.rm = TRUE)*100.0,
    pct_B5_4 = mean(B5_4_logic, na.rm = TRUE)*100.0,
    pct_B5_5 = mean(B5_5_logic, na.rm = TRUE)*100.0,
    pct_C3 = mean(C3_logic, na.rm = TRUE)*100.0,
    pct_C7 = mean(C7_logic, na.rm = TRUE)*100.0,
    mean_C10_1_1 = mean(C10_1_1, na.rm = TRUE),
    mean_C10_2_1 = mean(C10_2_1, na.rm = TRUE),
    mean_C10_3_1 = mean(C10_3_1, na.rm = TRUE),
    pct_C11_1 = mean(C11_logic, na.rm = TRUE)*100.0,
    pct_C1_1 = mean(C1_1_logic, na.rm = TRUE)*100.0,
    pct_C1_2 = mean(C1_2_logic, na.rm = TRUE)*100.0,
    pct_C1_3 = mean(C1_3_logic, na.rm = TRUE)*100.0,
    pct_C1_4 = mean(C1_4_logic, na.rm = TRUE)*100.0,
    pct_C1_5 = mean(C1_5_logic, na.rm = TRUE)*100.0,
    pct_C1_6 = mean(C1_6_logic, na.rm = TRUE)*100.0,
    pct_C1_7 = mean(C1_7_logic, na.rm = TRUE)*100.0,
    pct_C1_8 = mean(C1_8_logic, na.rm = TRUE)*100.0,
    pct_C1_9 = mean(C1_9_logic, na.rm = TRUE)*100.0,
    pct_C1_multi = mean(C1_multi_logic, na.rm = TRUE)*100.0,
    pct_cli_weighted = sum(cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_ili_weighted = sum(ili*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cli_anosmia_ageusia_weighted = sum(cli_anosmia_ageusia*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_hh_cli_weighted = sum(hh_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_cmnty_cli_weighted = sum(cmnty_cli*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_1_weighted = sum(A1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_2_weighted = sum(A1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_3_weighted = sum(A1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_4_weighted = sum(A1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_A1_5_weighted = sum(A1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_A2_weighted = sum(A2*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_A4_weighted = sum(A4*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_B2_1_weighted = sum(B2_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_2_weighted = sum(B2_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_3_weighted = sum(B2_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_4_weighted = sum(B2_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_5_weighted = sum(B2_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_6_weighted = sum(B2_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_7_weighted = sum(B2_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_8_weighted = sum(B2_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_9_weighted = sum(B2_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_10_weighted = sum(B2_10_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_11_weighted = sum(B2_11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_12_weighted = sum(B2_12_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_13_weighted = sum(B2_13_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_14_weighted = sum(B2_14_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_15_weighted = sum(B2_15_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B2_multi_weighted = sum(B2_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_1_weighted = sum(B5_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_2_weighted = sum(B5_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_3_weighted = sum(B5_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_4_weighted = sum(B5_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_B5_5_weighted = sum(B5_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C3_weighted = sum(C3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C7_weighted = sum(C7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    mean_C10_1_1_weighted = sum(C10_1_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_2_1_weighted = sum(C10_2_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    mean_C10_3_1_weighted = sum(C10_3_1*weight, na.rm = TRUE)*1.0/sum(weight, na.rm = TRUE),
    pct_C11_1_weighted = sum(C11_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_1_weighted = sum(C1_1_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_2_weighted = sum(C1_2_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_3_weighted = sum(C1_3_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_4_weighted = sum(C1_4_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_5_weighted = sum(C1_5_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_6_weighted = sum(C1_6_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_7_weighted = sum(C1_7_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_8_weighted = sum(C1_8_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_9_weighted = sum(C1_9_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE),
    pct_C1_multi_weighted = sum(C1_multi_logic*weight, na.rm = TRUE)*100.0/sum(weight, na.rm = TRUE)
  )
names(state_overall_grouped_data)[names(state_overall_grouped_data) == "gender_overall"] <- "gender"
names(state_overall_grouped_data)[names(state_overall_grouped_data) == "age_bucket_overall"] <- "age_bucket"

### UNION ALL THE DATA TOGETHER
  nrow(state_gender_age_grouped_data) +
  nrow(state_gender_grouped_data) +
  nrow(state_age_grouped_data) +
  nrow(state_overall_grouped_data)

state_overall = rbind(state_gender_age_grouped_data, state_gender_grouped_data, state_age_grouped_data, state_overall_grouped_data)
nrow(state_overall)

### FILTER ONLY ONLY ROWS THAT HAVE GREATER THAN 100 RESPONSES
state_overall_filt = state_overall[which(state_overall$n >= MIN_SAMPLE_SIZE), ]

state_overall_filt <- round_df(state_overall_filt, "mean_")
state_overall_filt <- round_df(state_overall_filt, "pct_")

state_overall_filt_fixed_names <- state_overall_filt

for (col in names(state_overall_filt_fixed_names)) {
  core = str_remove(str_remove(str_remove(str_remove(col, 'pct_'), '_weighted'), 'smoothed_'), 'mean_')
  variable = col_dict$get(core)
  fixed = gsub(core, variable, col)
  names(state_overall_filt_fixed_names)[names(state_overall_filt_fixed_names) == col] <- fixed
}

write_csv(state_overall_filt_fixed_names, "overall-state.csv")

### SMOOTH ALL THE DATA (LAST 7 DAYS), USING THE AGGREGATED DATA ABOVE.
# All smoothing done by multiplying any day's results by the sample size of the day, and then dividing by the sum of sample across all the days
state_smoothed_overall = state_overall %>%
  arrange(state_code, gender, age_bucket, desc(date)) %>%
  group_by(state_code, gender, age_bucket) %>%
  mutate(summed_n = rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_cli = rollsum(pct_cli*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_ili = rollsum(pct_ili*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_cli_anosmia_ageusia = rollsum(pct_cli_anosmia_ageusia*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_hh_cli = rollsum(pct_hh_cli*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_cmnty_cli = rollsum(pct_cmnty_cli*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_1 = rollsum(pct_A1_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_2 = rollsum(pct_A1_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_3 = rollsum(pct_A1_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_4 = rollsum(pct_A1_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_5 = rollsum(pct_A1_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_A2 = rollsum(mean_A2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_A4 = rollsum(mean_A4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_1 = rollsum(pct_B2_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_2 = rollsum(pct_B2_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_3 = rollsum(pct_B2_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_4 = rollsum(pct_B2_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_5 = rollsum(pct_B2_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_6 = rollsum(pct_B2_6*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_7 = rollsum(pct_B2_7*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_8 = rollsum(pct_B2_8*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_9 = rollsum(pct_B2_9*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_10 = rollsum(pct_B2_10*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_11 = rollsum(pct_B2_11*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_12 = rollsum(pct_B2_12*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_13 = rollsum(pct_B2_13*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_14 = rollsum(pct_B2_14*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_15 = rollsum(pct_B2_15*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_multi = rollsum(pct_B2_multi*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_1 = rollsum(pct_B5_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_2 = rollsum(pct_B5_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_3 = rollsum(pct_B5_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_4 = rollsum(pct_B5_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_5 = rollsum(pct_B5_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C3 = rollsum(pct_C3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C7 = rollsum(pct_C7*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_C10_1_1 = rollsum(mean_C10_1_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_C10_2_1 = rollsum(mean_C10_2_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_C10_3_1 = rollsum(mean_C10_3_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C11_1 = rollsum(pct_C11_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_1 = rollsum(pct_C1_1*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_2 = rollsum(pct_C1_2*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_3 = rollsum(pct_C1_3*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_4 = rollsum(pct_C1_4*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_5 = rollsum(pct_C1_5*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_6 = rollsum(pct_C1_6*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_7 = rollsum(pct_C1_7*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_8 = rollsum(pct_C1_8*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_9 = rollsum(pct_C1_9*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_multi = rollsum(pct_C1_multi*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_cli_weighted = rollsum(pct_cli_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_ili_weighted = rollsum(pct_ili_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_cli_anosmia_ageusia_weighted = rollsum(pct_cli_anosmia_ageusia_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_hh_cli_weighted = rollsum(pct_hh_cli_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_cmnty_cli_weighted = rollsum(pct_cmnty_cli_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_1_weighted = rollsum(pct_A1_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_2_weighted = rollsum(pct_A1_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_3_weighted = rollsum(pct_A1_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_4_weighted = rollsum(pct_A1_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_A1_5_weighted = rollsum(pct_A1_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_A2_weighted = rollsum(mean_A2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_A4_weighted = rollsum(mean_A4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_1_weighted = rollsum(pct_B2_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_2_weighted = rollsum(pct_B2_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_3_weighted = rollsum(pct_B2_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_4_weighted = rollsum(pct_B2_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_5_weighted = rollsum(pct_B2_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_6_weighted = rollsum(pct_B2_6_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_7_weighted = rollsum(pct_B2_7_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_8_weighted = rollsum(pct_B2_8_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_9_weighted = rollsum(pct_B2_9_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_10_weighted = rollsum(pct_B2_10_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_11_weighted = rollsum(pct_B2_11_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_12_weighted = rollsum(pct_B2_12_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_13_weighted = rollsum(pct_B2_13_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_14_weighted = rollsum(pct_B2_14_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_15_weighted = rollsum(pct_B2_15_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B2_multi_weighted = rollsum(pct_B2_multi_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_1_weighted = rollsum(pct_B5_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_2_weighted = rollsum(pct_B5_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_3_weighted = rollsum(pct_B5_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_4_weighted = rollsum(pct_B5_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_B5_5_weighted = rollsum(pct_B5_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C3_weighted = rollsum(pct_C3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C7_weighted = rollsum(pct_C7_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_C10_1_1_weighted = rollsum(mean_C10_1_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_C10_2_1_weighted = rollsum(mean_C10_2_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_mean_C10_3_1_weighted = rollsum(mean_C10_3_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C11_1_weighted = rollsum(pct_C11_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_1_weighted = rollsum(pct_C1_1_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_2_weighted = rollsum(pct_C1_2_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_3_weighted = rollsum(pct_C1_3_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_4_weighted = rollsum(pct_C1_4_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_5_weighted = rollsum(pct_C1_5_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_6_weighted = rollsum(pct_C1_6_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_7_weighted = rollsum(pct_C1_7_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_8_weighted = rollsum(pct_C1_8_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_9_weighted = rollsum(pct_C1_9_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
         smoothed_pct_C1_multi_weighted = rollsum(pct_C1_multi_weighted*n, k = 7, fill = NA, align = "left")*1.0/rollsum(n, k = 7, fill = NA, align = "left"),
  )

key_state_smoothed_variables <- c('date', 'state_code', 'gender', 'age_bucket', 'summed_n','smoothed_pct_cli','smoothed_pct_ili', 'smoothed_pct_cli_anosmia_ageusia', 'smoothed_pct_hh_cli', 'smoothed_pct_cmnty_cli', 'smoothed_pct_A1_1','smoothed_pct_A1_2','smoothed_pct_A1_3',
                                  'smoothed_pct_A1_4','smoothed_pct_A1_5','smoothed_mean_A2','smoothed_mean_A4','smoothed_pct_B2_1', 'smoothed_pct_B2_2', 'smoothed_pct_B2_3', 'smoothed_pct_B2_4',
                                  'smoothed_pct_B2_5', 'smoothed_pct_B2_6', 'smoothed_pct_B2_7', 'smoothed_pct_B2_8', 'smoothed_pct_B2_9', 'smoothed_pct_B2_10',
                                  'smoothed_pct_B2_11', 'smoothed_pct_B2_12', 'smoothed_pct_B2_13', 'smoothed_pct_B2_14', 'smoothed_pct_B2_15','smoothed_pct_B2_multi',
                                  'smoothed_pct_B5_1', 'smoothed_pct_B5_2', 'smoothed_pct_B5_3', 'smoothed_pct_B5_4', 'smoothed_pct_B5_5', 'smoothed_pct_C3','smoothed_pct_C7',
                                  'smoothed_mean_C10_1_1','smoothed_mean_C10_2_1','smoothed_mean_C10_3_1','smoothed_pct_C11_1','smoothed_pct_C1_1','smoothed_pct_C1_2','smoothed_pct_C1_3',
                                  'smoothed_pct_C1_4','smoothed_pct_C1_5','smoothed_pct_C1_6','smoothed_pct_C1_7','smoothed_pct_C1_8','smoothed_pct_C1_9','smoothed_pct_C1_multi','smoothed_pct_cli_weighted',
                                  'smoothed_pct_ili_weighted','smoothed_pct_cli_anosmia_ageusia_weighted', 'smoothed_pct_hh_cli_weighted', 'smoothed_pct_cmnty_cli_weighted', 'smoothed_pct_A1_1_weighted','smoothed_pct_A1_2_weighted','smoothed_pct_A1_3_weighted','smoothed_pct_A1_4_weighted',
                                  'smoothed_pct_A1_5_weighted','smoothed_mean_A2_weighted','smoothed_mean_A4_weighted','smoothed_pct_B2_1_weighted', 'smoothed_pct_B2_2_weighted', 'smoothed_pct_B2_3_weighted',
                                  'smoothed_pct_B2_4_weighted', 'smoothed_pct_B2_5_weighted', 'smoothed_pct_B2_6_weighted', 'smoothed_pct_B2_7_weighted', 'smoothed_pct_B2_8_weighted','smoothed_pct_B2_9_weighted',
                                  'smoothed_pct_B2_10_weighted','smoothed_pct_B2_11_weighted', 'smoothed_pct_B2_12_weighted', 'smoothed_pct_B2_13_weighted', 'smoothed_pct_B2_14_weighted', 'smoothed_pct_B2_15_weighted',
                                  'smoothed_pct_B2_multi_weighted', 'smoothed_pct_B5_1_weighted', 'smoothed_pct_B5_2_weighted', 'smoothed_pct_B5_3_weighted',
                                  'smoothed_pct_B5_4_weighted', 'smoothed_pct_B5_5_weighted', 'smoothed_pct_C3_weighted',
                                  'smoothed_pct_C7_weighted','smoothed_mean_C10_1_1_weighted', 'smoothed_mean_C10_2_1_weighted','smoothed_mean_C10_3_1_weighted', 'smoothed_pct_C11_1_weighted', 'smoothed_pct_C1_1_weighted','smoothed_pct_C1_2_weighted','smoothed_pct_C1_3_weighted','smoothed_pct_C1_4_weighted','smoothed_pct_C1_5_weighted',
                                  'smoothed_pct_C1_6_weighted','smoothed_pct_C1_7_weighted','smoothed_pct_C1_8_weighted','smoothed_pct_C1_9_weighted','smoothed_pct_C1_multi_weighted')

state_smoothed_overall_rel_columns = state_smoothed_overall[key_state_smoothed_variables]
state_smoothed_overall_filt = state_smoothed_overall_rel_columns[which(state_smoothed_overall_rel_columns$summed_n >= MIN_SAMPLE_SIZE),]

state_smoothed_overall_filt <- round_df(state_smoothed_overall_filt, "smoothed_")

state_smoothed_overall_filt_fixed_names <- state_smoothed_overall_filt

for (col in names(state_smoothed_overall_filt_fixed_names)) {
  core = str_remove(str_remove(str_remove(str_remove(col, 'pct_'), '_weighted'), 'smoothed_'), 'mean_')
  variable = col_dict$get(core)
  fixed = gsub(core, variable, col)
  names(state_smoothed_overall_filt_fixed_names)[names(state_smoothed_overall_filt_fixed_names) == col] <- fixed
}

write_csv(state_smoothed_overall_filt_fixed_names, "overall-state-smoothed.csv")
